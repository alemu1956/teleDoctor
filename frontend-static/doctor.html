<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>TeleDoctor - Doctor Portal</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <style>
    body {
      background-color: #f0f9ff;
    }
  </style>
</head>

<body class="flex flex-col min-h-screen">
  <header class="bg-white shadow-md p-4 flex items-center justify-between">
    <div class="text-blue-700 font-bold text-xl">TeleDoctor - Doctor Portal</div>
    <button id="logout-btn" class="bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700">Logout</button>
  </header>

  <main class="flex-grow p-6 max-w-4xl mx-auto">
    <h1 class="text-3xl font-bold mb-6 text-center text-blue-700">Patient Recordings and Diagnoses</h1>

    <div class="shadow-lg rounded-lg p-8 bg-blue-50">
      <div class="flex flex-col gap-6">
        <div>
          <button id="load-both-btn" class="bg-blue-600 text-white px-6 py-3 rounded hover:bg-blue-700 transition">
            Load Latest Recording & Diagnosis
          </button>
        </div>

        <audio id="doctor-audio" controls crossorigin="use-credentials" class="w-full rounded-lg mt-4"></audio>

        <div id="diagnosis-info" class="bg-white p-6 rounded-lg mt-4 shadow">
          <h2 class="text-xl font-semibold mb-4 text-blue-800">Diagnosis Result</h2>
          <div id="diagnosis-text" class="text-gray-600">No diagnosis loaded yet.</div>
        </div>
      </div>
    </div>
  </main>

  <script>
    const token = localStorage.getItem('token');
    const role = localStorage.getItem('role');

    if (!token || role !== 'doctor') {
      alert('Doctor access required. Please login.');
      window.location.href = 'login.html';
    }

    document.getElementById('logout-btn').onclick = () => {
      localStorage.removeItem('token');
      localStorage.removeItem('role');
      window.location.href = 'login.html';
    };

    async function loadLatestData() {
      const audioPlayer = document.getElementById('doctor-audio');
      const diagnosisText = document.getElementById('diagnosis-text');

      try {
        // Clear previous audio source
        audioPlayer.src = '';

        // Create fresh URL with cache busting
        const audioUrl = `http://localhost:3000/latest-recording?t=${Date.now()}`;
        audioPlayer.src = audioUrl;

        // Add authorization token through query parameter
        const diagnosisResponse = await fetch('http://localhost:3000/latest-diagnosis', {
          headers: {
            'Authorization': 'Bearer ' + token
          }
        });

        if (!diagnosisResponse.ok) {
          const errorText = await diagnosisResponse.text();
          throw new Error(`Diagnosis error: ${diagnosisResponse.status} - ${errorText}`);
        }

        const diagnosisData = await diagnosisResponse.json();
        diagnosisText.innerHTML = `
          <p><strong>Local Language:</strong></p>
          <p>${diagnosisData.local}</p>
          <hr class="my-2" />
          <p><strong>English Translation:</strong></p>
          <p>${diagnosisData.english}</p>
        `;

      } catch (err) {
        console.error('Error loading data:', err);
        diagnosisText.innerHTML = `<p class="text-red-500">Error: ${err.message}</p>`;
      }
    }

    document.getElementById('load-both-btn').onclick = loadLatestData;

    // Auto-refresh every 5 minutes (300,000 ms)
    setInterval(loadLatestData, 300000);

    // Initial load
    loadLatestData();
  </script>
</body>

</html>