<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>TeleDoctor - Doctor Panel</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-gray-50 min-h-screen flex flex-col">
  <main class="flex-grow flex flex-col items-center justify-center p-6">
    <h1 class="text-3xl font-bold mb-4 text-blue-600">Audio Recording & Transcription</h1>
    <label for="language-select" class="mb-2">Select Language:</label>
    <select id="language-select" class="mb-6 p-2 border rounded">
      <option value="am">Amharic</option>
      <option value="om">Oromo</option>
      <option value="ti">Tigrinya</option>
      <option value="so">Somali</option>
      <option value="aa">Afar</option>
    </select>

    <div class="mb-4">
      <button id="start-btn" class="bg-blue-600 text-white px-4 py-2 rounded">Start Recording</button>
      <button id="stop-btn" disabled class="bg-red-600 text-white px-4 py-2 rounded ml-4">Stop Recording</button>
    </div>

    <audio id="audio-playback" controls class="mb-6 w-full max-w-md"></audio>

    <pre id="transcription-result" class="p-4 border rounded max-w-md min-h-[6rem] whitespace-pre-wrap"></pre>
  </main>

  <script>
    const startBtn = document.getElementById('start-btn');
    const stopBtn = document.getElementById('stop-btn');
    const playback = document.getElementById('audio-playback');
    const transcriptionResult = document.getElementById('transcription-result');
    const languageSelect = document.getElementById('language-select');

    let mediaRecorder;
    let audioChunks = [];

    startBtn.onclick = async () => {
      transcriptionResult.textContent = '';
      audioChunks = [];
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        mediaRecorder = new MediaRecorder(stream);
        mediaRecorder.start();

        mediaRecorder.ondataavailable = e => audioChunks.push(e.data);

        mediaRecorder.onstop = async () => {
          const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
          playback.src = URL.createObjectURL(audioBlob);

          // Prepare form data
          const formData = new FormData();
          formData.append('audio', audioBlob, 'recording.webm');
          formData.append('language', languageSelect.value);

          // Get JWT token from localStorage (must login first and save token!)
          const token = localStorage.getItem('token');
          if (!token) {
            transcriptionResult.textContent = 'Error: Please login to get a token.';
            return;
          }

          transcriptionResult.textContent = 'Transcribing... please wait.';

          try {
            const response = await fetch('http://localhost:3000/transcribe', {
              method: 'POST',
              headers: { 'Authorization': 'Bearer ' + token },
              body: formData,
            });

            if (!response.ok) {
              const text = await response.text();
              throw new Error(text);
            }

            const data = await response.json();
            transcriptionResult.textContent = `Local transcription:\n${data.local}\n\nEnglish translation:\n${data.english}`;
          } catch (err) {
            transcriptionResult.textContent = 'Error: ' + err.message;
          }
        };

        startBtn.disabled = true;
        stopBtn.disabled = false;
      } catch (err) {
        alert('Could not start recording: ' + err.message);
      }
    };

    stopBtn.onclick = () => {
      mediaRecorder.stop();
      startBtn.disabled = false;
      stopBtn.disabled = true;
    };
  </script>
</body>

</html>